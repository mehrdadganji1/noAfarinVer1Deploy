# ===========================================
# PRODUCTION DOCKER COMPOSE
# ===========================================
# Usage: docker-compose -f docker-compose.production.yml --env-file .env.production up -d

services:
  # MongoDB
  mongodb:
    image: mongo:7
    container_name: noafarin-mongodb
    restart: unless-stopped
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: ${MONGO_INITDB_ROOT_USERNAME}
      MONGO_INITDB_ROOT_PASSWORD: ${MONGO_INITDB_ROOT_PASSWORD}
      MONGO_INITDB_DATABASE: noafarin
    volumes:
      - mongodb_data:/data/db
    networks:
      - noafarin-network
    healthcheck:
      test: ["CMD", "mongosh", "--eval", "db.adminCommand('ping')"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # Redis
  redis:
    image: redis:7-alpine
    container_name: noafarin-redis
    restart: unless-stopped
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - noafarin-network
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: noafarin-rabbitmq
    restart: unless-stopped
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: ${RABBITMQ_DEFAULT_USER}
      RABBITMQ_DEFAULT_PASS: ${RABBITMQ_DEFAULT_PASS}
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - noafarin-network
    healthcheck:
      test: ["CMD", "rabbitmq-diagnostics", "-q", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s

  # API Gateway
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: noafarin-gateway
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      USER_SERVICE_URL: http://user-service:3001
      TEAM_SERVICE_URL: http://team-service:3002
      EVENT_SERVICE_URL: http://event-service:3003
      EVALUATION_SERVICE_URL: http://evaluation-service:3004
      TRAINING_SERVICE_URL: http://training-service:3005
      FUNDING_SERVICE_URL: http://funding-service:3006
      FILE_SERVICE_URL: http://file-service:3007
      APPLICATION_SERVICE_URL: http://application-service:3008
      LEARNING_SERVICE_URL: http://learning-service:3013
      XP_SERVICE_URL: http://xp-service:3011
      ACHIEVEMENT_SERVICE_URL: http://achievement-service:3012
      PROJECT_SERVICE_URL: http://project-service:3010
      REDIS_URL: ${REDIS_URL}
      JWT_SECRET: ${JWT_SECRET}
      FRONTEND_URL: ${FRONTEND_URL}
    depends_on:
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: noafarin-user-service
    restart: unless-stopped
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
      JWT_EXPIRES_IN: ${JWT_EXPIRES_IN}
      REFRESH_TOKEN_EXPIRES_IN: ${REFRESH_TOKEN_EXPIRES_IN}
      EMAIL_ENABLED: ${EMAIL_ENABLED}
      SMTP_HOST: ${SMTP_HOST}
      SMTP_PORT: ${SMTP_PORT}
      SMTP_USER: ${SMTP_USER}
      SMTP_PASS: ${SMTP_PASS}
      SMTP_FROM: ${SMTP_FROM}
      SMS_IR_API_KEY: ${SMS_IR_API_KEY}
      FRONTEND_URL: ${FRONTEND_URL}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # Team Service
  team-service:
    build:
      context: ./services/team-service
      dockerfile: Dockerfile
    container_name: noafarin-team-service
    restart: unless-stopped
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # Event Service
  event-service:
    build:
      context: ./services/event-service
      dockerfile: Dockerfile
    container_name: noafarin-event-service
    restart: unless-stopped
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: production
      PORT: 3003
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # Evaluation Service
  evaluation-service:
    build:
      context: ./services/evaluation-service
      dockerfile: Dockerfile
    container_name: noafarin-evaluation-service
    restart: unless-stopped
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: production
      PORT: 3004
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # Training Service
  training-service:
    build:
      context: ./services/training-service
      dockerfile: Dockerfile
    container_name: noafarin-training-service
    restart: unless-stopped
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: production
      PORT: 3005
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # Funding Service
  funding-service:
    build:
      context: ./services/funding-service
      dockerfile: Dockerfile
    container_name: noafarin-funding-service
    restart: unless-stopped
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: production
      PORT: 3006
      MONGODB_URI: ${MONGODB_URI}
      REDIS_URL: ${REDIS_URL}
      RABBITMQ_URL: ${RABBITMQ_URL}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
      redis:
        condition: service_healthy
      rabbitmq:
        condition: service_healthy
    networks:
      - noafarin-network

  # File Service
  file-service:
    build:
      context: ./services/file-service
      dockerfile: Dockerfile
    container_name: noafarin-file-service
    restart: unless-stopped
    ports:
      - "3007:3007"
    environment:
      NODE_ENV: production
      PORT: 3007
      MONGODB_URI: ${MONGODB_URI}
      BASE_URL: ${FILE_SERVICE_BASE_URL}
      JWT_SECRET: ${JWT_SECRET}
    volumes:
      - file_uploads:/app/uploads
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # Application Service
  application-service:
    build:
      context: ./services/application-service
      dockerfile: Dockerfile
    container_name: noafarin-application-service
    restart: unless-stopped
    ports:
      - "3008:3008"
    environment:
      NODE_ENV: production
      PORT: 3008
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # Learning Service
  learning-service:
    build:
      context: ./services/learning-service
      dockerfile: Dockerfile
    container_name: noafarin-learning-service
    restart: unless-stopped
    ports:
      - "3013:3013"
    environment:
      NODE_ENV: production
      PORT: 3013
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # XP Service
  xp-service:
    build:
      context: ./services/xp-service
      dockerfile: Dockerfile
    container_name: noafarin-xp-service
    restart: unless-stopped
    ports:
      - "3011:3011"
    environment:
      NODE_ENV: production
      PORT: 3011
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # Achievement Service
  achievement-service:
    build:
      context: ./services/achievement-service
      dockerfile: Dockerfile
    container_name: noafarin-achievement-service
    restart: unless-stopped
    ports:
      - "3012:3012"
    environment:
      NODE_ENV: production
      PORT: 3012
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # Project Service
  project-service:
    build:
      context: ./services/project-service
      dockerfile: Dockerfile
    container_name: noafarin-project-service
    restart: unless-stopped
    ports:
      - "3010:3010"
    environment:
      NODE_ENV: production
      PORT: 3010
      MONGODB_URI: ${MONGODB_URI}
      JWT_SECRET: ${JWT_SECRET}
    depends_on:
      mongodb:
        condition: service_healthy
    networks:
      - noafarin-network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.production
      args:
        VITE_API_URL: ${VITE_API_URL}
        VITE_FILE_SERVICE_URL: ${VITE_API_URL}
    container_name: noafarin-frontend
    restart: unless-stopped
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./frontend/ssl:/etc/nginx/ssl:ro
    depends_on:
      - api-gateway
    networks:
      - noafarin-network

networks:
  noafarin-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  file_uploads:

version: '3.8'

services:
  # MongoDB
  mongodb:
    image: mongo:7
    container_name: noafarin-mongodb
    restart: always
    ports:
      - "27017:27017"
    environment:
      MONGO_INITDB_ROOT_USERNAME: admin
      MONGO_INITDB_ROOT_PASSWORD: admin123
      MONGO_INITDB_DATABASE: noafarin
    volumes:
      - mongodb_data:/data/db
    networks:
      - noafarin-network

  # Redis
  redis:
    image: redis:7-alpine
    container_name: noafarin-redis
    restart: always
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - noafarin-network

  # RabbitMQ
  rabbitmq:
    image: rabbitmq:3-management-alpine
    container_name: noafarin-rabbitmq
    restart: always
    ports:
      - "5672:5672"
      - "15672:15672"
    environment:
      RABBITMQ_DEFAULT_USER: admin
      RABBITMQ_DEFAULT_PASS: admin123
    volumes:
      - rabbitmq_data:/var/lib/rabbitmq
    networks:
      - noafarin-network

  # API Gateway
  api-gateway:
    build:
      context: ./services/api-gateway
      dockerfile: Dockerfile
    container_name: noafarin-gateway
    restart: always
    ports:
      - "3000:3000"
    environment:
      NODE_ENV: production
      PORT: 3000
      USER_SERVICE_URL: http://user-service:3001
      TEAM_SERVICE_URL: http://team-service:3002
      EVENT_SERVICE_URL: http://event-service:3003
      EVALUATION_SERVICE_URL: http://evaluation-service:3004
      TRAINING_SERVICE_URL: http://training-service:3005
      FUNDING_SERVICE_URL: http://funding-service:3006
      FILE_SERVICE_URL: http://file-service:3007
      REDIS_URL: redis://redis:6379
    depends_on:
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # User Service
  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: noafarin-user-service
    restart: always
    ports:
      - "3001:3001"
    environment:
      NODE_ENV: production
      PORT: 3001
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
      JWT_SECRET: your-super-secret-jwt-key-change-in-production
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # Team Service
  team-service:
    build:
      context: ./services/team-service
      dockerfile: Dockerfile
    container_name: noafarin-team-service
    restart: always
    ports:
      - "3002:3002"
    environment:
      NODE_ENV: production
      PORT: 3002
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # Event Service
  event-service:
    build:
      context: ./services/event-service
      dockerfile: Dockerfile
    container_name: noafarin-event-service
    restart: always
    ports:
      - "3003:3003"
    environment:
      NODE_ENV: production
      PORT: 3003
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # Evaluation Service
  evaluation-service:
    build:
      context: ./services/evaluation-service
      dockerfile: Dockerfile
    container_name: noafarin-evaluation-service
    restart: always
    ports:
      - "3004:3004"
    environment:
      NODE_ENV: production
      PORT: 3004
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # Training Service
  training-service:
    build:
      context: ./services/training-service
      dockerfile: Dockerfile
    container_name: noafarin-training-service
    restart: always
    ports:
      - "3005:3005"
    environment:
      NODE_ENV: production
      PORT: 3005
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # Funding Service
  funding-service:
    build:
      context: ./services/funding-service
      dockerfile: Dockerfile
    container_name: noafarin-funding-service
    restart: always
    ports:
      - "3006:3006"
    environment:
      NODE_ENV: production
      PORT: 3006
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      REDIS_URL: redis://redis:6379
      RABBITMQ_URL: amqp://admin:admin123@rabbitmq:5672
    depends_on:
      - mongodb
      - redis
      - rabbitmq
    networks:
      - noafarin-network

  # File Service
  file-service:
    build:
      context: ./services/file-service
      dockerfile: Dockerfile
    container_name: noafarin-file-service
    restart: always
    ports:
      - "3007:3007"
    environment:
      NODE_ENV: production
      PORT: 3007
      MONGODB_URI: mongodb://admin:admin123@mongodb:27017/noafarin?authSource=admin
      BASE_URL: http://localhost:3007
    volumes:
      - file_uploads:/app/uploads
    depends_on:
      - mongodb
    networks:
      - noafarin-network

  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: noafarin-frontend
    restart: always
    ports:
      - "80:80"
    environment:
      VITE_API_URL: http://localhost:3000
    depends_on:
      - api-gateway
    networks:
      - noafarin-network

networks:
  noafarin-network:
    driver: bridge

volumes:
  mongodb_data:
  redis_data:
  rabbitmq_data:
  file_uploads:
